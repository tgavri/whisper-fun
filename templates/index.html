<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Whisper Transcription</title>
  <script src="/static/tailwind.17.js"></script>
  <script src="/static/highlight.min.js"></script>
  <link rel="stylesheet" href="/static/github-dark.min.css">
</head>
<body class="bg-gray-900 text-white">

<div class="min-h-screen flex flex-col items-center justify-center p-6">

  <h1 class="text-3xl font-bold mb-6 text-center">Audio Transskribering med Whisper</h1>
  <h1 class="text-2xl font-bold mb-6 text-center">Omdan lyd til tekst</h1>
  <h1 class="text-1xl font-bold mb-6 text-center">It's real magic!</h1>

<!-- Language selection -->
<div class="mt-4 w-full max-w-xl">
  <label for="languageSelect" class="text-gray-200 mb-1 block">Language</label>
  <select id="languageSelect" class="w-full px-3 py-2 rounded-md bg-gray-800 text-gray-100 border border-gray-600">
    <option value="">Auto - detect language</option>
    <option value="da">Danish</option>
    <option value="en">English</option>
    <option value="sv">Swedish</option>
    <option value="de">German</option>
    <option value="fr">French</option>
    <option value="es">Spanish</option>
    <option value="ko">Korean</option>
    <!-- Add more as needed, using ISO 639-1 codes -->
  </select>
</div>

  <!-- Drop/Upload zone -->
  <div id="dropZone" class="w-full max-w-xl border-2 border-dashed border-gray-500 rounded-lg p-8 text-center cursor-pointer hover:border-indigo-400 transition">
    <p class="text-gray-300">Drag & drop your audio file here or click to browse</p>
    <input id="fileInput" type="file" name="file" accept=".mp3,.wav,.flac,.m4a,.ogg,.webm" class="hidden"/>
  </div>

  <!-- Audio preview -->
  <div id="audioPreviewContainer" class="mt-4 hidden w-full max-w-xl">
    <audio id="audioPreview" controls class="w-full"></audio>
  </div>

  <!-- Recording button (toggles dynamically) -->
  <div class="mt-4">
  <button id="recordBtn" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded shadow">
    Start Recording
  </button>  
  </div>

  <!-- Upload/transcribe button -->
  <button id="uploadBtn" class="mt-4 px-6 py-2 bg-indigo-600 hover:bg-indigo-500 rounded shadow disabled:opacity-50" disabled>Transcribe</button>

  <!-- Export SRT button-->
   <button id="uploadSrtBtn" class="mt-4 ml-2 px-6 py-2 bg-purple-600 hover:bg-purple-500 rounded shadow disabled:opacity-50" disabled>Export SRT</button>

  <!-- Loading spinner -->
  <div id="loading" class="hidden mt-6">
    <svg class="animate-spin h-8 w-8 text-indigo-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
    </svg>
    <p class="mt-2 text-sm text-gray-400">Transcribing… please wait</p>
  </div>

  <!-- Result -->
  <div id="resultCard" class="hidden mt-8 w-full max-w-3xl bg-gray-800 rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold mb-2">Transcript</h2>
    <p id="transcriptText" class="mb-4 whitespace-pre-wrap text-gray-200"></p>
    <h3 class="text-lg font-semibold mb-2">Full JSON Response</h3>
    <pre><code id="jsonOutput" class="json"></code></pre>
  </div>

  <!-- Record/Translate Section Below Other Content -->
  <div class="mt-8 w-full max-w-xl bg-gray-700 rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold mb-2">Live Translate</h2>
    <button id="translateRecordBtn" class="px-4 py-2 bg-yellow-700 hover:bg-yellow-600 rounded shadow">Record & Translate</button>
    <audio id="translateAudioPreview" controls class="w-full mt-4 hidden"></audio>
    <div id="liveTranslationResult" class="mt-4 text-gray-100"></div>
  </div>

  <!-- Translated Text Section -->
  <div id="translatedTextContainer" class="hidden mt-8 w-full max-w-3xl bg-gray-800 rounded-lg shadow p-6">
      <h2 class="text-xl font-semibold mb-2">Translated Text</h2>
      <p id="translatedText" class="mb-4 whitespace-pre-wrap text-gray-200"></p>
  </div>



</div>

<script>
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const uploadBtn = document.getElementById('uploadBtn');
const loading = document.getElementById('loading');
const resultCard = document.getElementById('resultCard');
const transcriptText = document.getElementById('transcriptText');
const jsonOutput = document.getElementById('jsonOutput');
const audioPreviewContainer = document.getElementById('audioPreviewContainer');
const audioPreview = document.getElementById('audioPreview');

const startRecordingBtn = document.getElementById('startRecording');
const stopRecordingBtn = document.getElementById('stopRecording');

let selectedFile = null;
let mediaRecorder;
let audioChunks = [];

function showFile(file) {
  selectedFile = file;
  uploadBtn.disabled = false;
  uploadSrtBtn.disabled = false; 

  const lang = languageSelect.value || langCode;
  const fileSelectedFn = translations[lang]?.fileSelected || translations.en.fileSelected;
  dropZone.querySelector('p').textContent = `Selected: ${selectedFile.name}`;

  const objectURL = URL.createObjectURL(selectedFile);
  audioPreview.src = objectURL;
  audioPreviewContainer.classList.remove("hidden");
}

// ==== Upload / drag & drop handling ====
dropZone.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', () => {
  if(fileInput.files.length) showFile(fileInput.files[0]);
});
dropZone.addEventListener('dragover', e => {
  e.preventDefault();
  dropZone.classList.add('border-indigo-400');
});
dropZone.addEventListener('dragleave', () => {
  dropZone.classList.remove('border-indigo-400');
});
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('border-indigo-400');
  if(e.dataTransfer.files.length) showFile(e.dataTransfer.files[0]);
});

// ==== Recording handling ====
const recordBtn = document.getElementById('recordBtn');
let isRecording = false;

recordBtn.onclick = async () => {
  if (!isRecording) {
    // Start recording
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) audioChunks.push(e.data);
      };
      mediaRecorder.start();
      isRecording = true;
      recordBtn.textContent = "Stop Recording";
      recordBtn.classList.remove('bg-green-600','hover:bg-green-500');
      recordBtn.classList.add('bg-red-600','hover:bg-red-500');
      dropZone.querySelector('p').textContent = "Recording... Speak now.";
    } catch (err) {
      alert("Microphone access denied or unavailable.");
    }
  } else {
    // Stop recording
    mediaRecorder.stop();
    mediaRecorder.onstop = () => {
      const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      showFile(new File([audioBlob], "recording.webm", { type: "audio/webm" }));
    };
    isRecording = false;
    recordBtn.textContent = "Start Recording";
    recordBtn.classList.remove('bg-red-600','hover:bg-red-500');
    recordBtn.classList.add('bg-green-600','hover:bg-green-500');
  }
};

// ==== Transcribe submission ====
const languageSelect = document.getElementById('languageSelect');

uploadBtn.addEventListener('click', async () => {
  if (!selectedFile) return;
  const formData = new FormData();
  formData.append("file", selectedFile);
  formData.append("language", languageSelect.value);

  loading.classList.remove('hidden');
  resultCard.classList.add('hidden');
  uploadBtn.disabled = true;

  const res = await fetch('/translate', { method: 'POST', body: formData });
  let data;
  try { data = await res.json(); }
  catch (e) {
    liveTranslationResult.innerHTML = "Translation error, no response.";
    return;
  }
  if (!res.ok) {
    liveTranslationResult.innerHTML = `Error: ${data.error || "Unknown error"}`;
    return;
  }
  liveTranslationResult.innerHTML = `<b>Detected:</b> ${data.detected_language}<br><b>Original:</b> ${data.original_text}<br><b>Translation:</b> ${data.translated_text}`;

});

const uploadSrtBtn = document.getElementById('uploadSrtBtn');

uploadSrtBtn.addEventListener('click', async () => {
  if (!selectedFile) return;
  const formData = new FormData();
  formData.append("file", selectedFile);
  formData.append("language", languageSelect.value);

  uploadSrtBtn.disabled = true;
  try {
    const res = await fetch('/transcribe/srt', { method: 'POST', body: formData });
    if (!res.ok) throw new Error(await res.text());

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'subtitles.srt';
    document.body.appendChild(a);
    a.click();
    a.remove();
  } catch (err) {
    alert("Error: " + err.message);
  } finally {
    uploadSrtBtn.disabled = false;
  }
});

const translations = {
  en: {
    title: "Audio Transcription with Whisper",
    subtitle: "Turn audio into text",
    magic: "It's real magic!",
    dragDrop: "Drag & drop your audio file here or click to browse",
    languageLabel: "Language",
    recordStart: "Start Recording",
    recordStop: "Stop Recording",
    transcribe: "Transcribe",
    exportSrt: "Export SRT",
    loading: "Transcribing… please wait",
    transcript: "Transcript",
    json: "Full JSON Response",
    recording: "Recording... Speak now.",
    fileSelected: name => `Selected: ${name}`
  },
  da: {
    title: "Audio Transskribering med Whisper",
    subtitle: "Omdan lyd til tekst",
    magic: "Det er ægte magi!",
    dragDrop: "Træk og slip din lydfil her eller klik for at vælge",
    languageLabel: "Sprog",
    recordStart: "Start optagelse",
    recordStop: "Stop optagelse",
    transcribe: "Transskriber",
    exportSrt: "Eksporter SRT",
    loading: "Transskriberer... vent venligst",
    transcript: "Udskrift",
    json: "Fuldt JSON-svar",
    recording: "Optager... Tal nu.",
    fileSelected: name => `Valgt: ${name}`
  },
  sv: {
    title: "Ljudtranskribering med Whisper",
    subtitle: "Omvandla ljud till text",
    magic: "Det är riktig magi!",
    dragDrop: "Dra och släpp din ljudfil här eller klicka för att bläddra",
    languageLabel: "Språk",
    recordStart: "Starta inspelning",
    recordStop: "Stoppa inspelning",
    transcribe: "Transkribera",
    exportSrt: "Exportera SRT",
    loading: "Transkriberar... vänligen vänta",
    transcript: "Transkription",
    json: "Full JSON-respons",
    recording: "Spelar in... Prata nu.",
    fileSelected: name => `Vald: ${name}`
  },
  de: {
    title: "Audio-Transkription mit Whisper",
    subtitle: "Audio in Text umwandeln",
    magic: "Es ist echte Magie!",
    dragDrop: "Datei hierher ziehen oder klicken zum Hochladen",
    languageLabel: "Sprache",
    recordStart: "Aufnahme starten",
    recordStop: "Aufnahme stoppen",
    transcribe: "Transkribieren",
    exportSrt: "SRT exportieren",
    loading: "Transkribieren... bitte warten",
    transcript: "Transkript",
    json: "Vollständige JSON-Antwort",
    recording: "Nehme auf... Sprich jetzt.",
    fileSelected: name => `Ausgewählt: ${name}`
  },
  fr: {
    title: "Transcription audio avec Whisper",
    subtitle: "Transformer l’audio en texte",
    magic: "C’est de la vraie magie !",
    dragDrop: "Glissez-déposez votre fichier audio ou cliquez pour parcourir",
    languageLabel: "Langue",
    recordStart: "Démarrer l’enregistrement",
    recordStop: "Arrêter l’enregistrement",
    transcribe: "Transcrire",
    exportSrt: "Exporter en SRT",
    loading: "Transcription en cours… veuillez patienter",
    transcript: "Transcription",
    json: "Réponse JSON complète",
    recording: "Enregistrement... Parlez maintenant.",
    fileSelected: name => `Sélectionné : ${name}`
  },
  es: {
    title: "Transcripción de audio con Whisper",
    subtitle: "Convierte audio en texto",
    magic: "¡Es magia de verdad!",
    dragDrop: "Arrastra y suelta tu archivo de audio aquí o haz clic para buscar",
    languageLabel: "Idioma",
    recordStart: "Iniciar grabación",
    recordStop: "Detener grabación",
    transcribe: "Transcribir",
    exportSrt: "Exportar SRT",
    loading: "Transcribiendo... por favor espera",
    transcript: "Transcripción",
    json: "Respuesta JSON completa",
    recording: "Grabando... Habla ahora.",
    fileSelected: name => `Seleccionado: ${name}`
  },
  ko: {
  title: "Whisper로 오디오 전사",
  subtitle: "오디오를 텍스트로 변환",
  magic: "진짜 마법 같아요!",
  dragDrop: "오디오 파일을 여기로 드래그하거나 클릭해서 선택하세요",
  languageLabel: "언어",
  recordStart: "녹음 시작",
  recordStop: "녹음 중지",
  transcribe: "전사하기",
  exportSrt: "SRT 내보내기",
  loading: "전사 중... 잠시만 기다려주세요",
  transcript: "전사 결과",
  json: "전체 JSON 응답",
  recording: "녹음 중... 말씀해주세요.",
  fileSelected: name => `선택됨: ${name}`
}
};

function applyTranslations(lang) {
  const t = translations[lang] || translations.en;

  document.querySelectorAll("h1")[0].textContent = t.title;
  document.querySelectorAll("h1")[1].textContent = t.subtitle;
  document.querySelectorAll("h1")[2].textContent = t.magic;

  document.querySelector('label[for="languageSelect"]').textContent = t.languageLabel;
  document.querySelector('#dropZone p').textContent = t.dragDrop;

  const recordBtn = document.getElementById('recordBtn');
  recordBtn.textContent = t.recordStart;

  document.getElementById("uploadBtn").textContent = t.transcribe;
  document.getElementById("uploadSrtBtn").textContent = t.exportSrt;

  document.querySelector("#loading p").textContent = t.loading;

  document.querySelector('#resultCard h2').textContent = t.transcript;
  document.querySelector('#resultCard h3').textContent = t.json;

  // Hook into record button toggle text
  recordBtn.dataset.textStart = t.recordStart;
  recordBtn.dataset.textStop = t.recordStop;

  // Custom message for dropzone update
  recordBtn.dataset.textRecording = t.recording;
  dropZone.dataset.fileSelected = t.fileSelected;
}

// Detect browser language and apply
const userLang = navigator.language || navigator.userLanguage || "en";
const langCode = userLang.split('-')[0];
applyTranslations(langCode);

const translateRecordBtn = document.getElementById('translateRecordBtn');
const translateAudioPreview = document.getElementById('translateAudioPreview');
const liveTranslationResult = document.getElementById('liveTranslationResult');

let translationRecorder, translationAudioChunks = [];
translateRecordBtn.onclick = async () => {
  if (!translationRecorder || translationRecorder.state === 'inactive') {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    translationRecorder = new MediaRecorder(stream);
    translationAudioChunks = [];
    translationRecorder.ondataavailable = e => translationAudioChunks.push(e.data);
    translationRecorder.onstop = async () => {
      const blob = new Blob(translationAudioChunks, { type: 'audio/webm' });
      const file = new File([blob], "translation.webm", { type: "audio/webm" });
      // Preview
      translateAudioPreview.src = URL.createObjectURL(blob);
      translateAudioPreview.classList.remove('hidden');
      // Upload + translate
      const formData = new FormData();
      formData.append("file", file);
      formData.append("language", languageSelect.value || "en"); // Use language dropdown choice as target
      liveTranslationResult.textContent = "Translating...";
      const res = await fetch('/translate', { method: 'POST', body: formData });
      const data = await res.json();
      liveTranslationResult.innerHTML = `<b>Detected:</b> ${data.detected_language}<br><b>Original:</b> ${data.original_text}<br><b>Translation:</b> ${data.translated_text}`;
    };
    translationRecorder.start();
    translateRecordBtn.textContent = "Stop";
  } else {
    translationRecorder.stop();
    translateRecordBtn.textContent = "Record & Translate";
  }
};



</script>

</body>
</html>
