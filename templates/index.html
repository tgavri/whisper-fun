<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Whisper Transcription</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
</head>
<body class="bg-gray-900 text-white">

<div class="min-h-screen flex flex-col items-center justify-center p-6">

  <h1 class="text-3xl font-bold mb-6 text-center">Audio Transskribering med Whisper</h1>
  <h1 class="text-2xl font-bold mb-6 text-center">Omdan lyd til tekst</h1>
  <h1 class="text-1xl font-bold mb-6 text-center">It's real magic!</h1>

<!-- Language selection -->
<div class="mt-4 w-full max-w-xl">
  <label for="languageSelect" class="text-gray-200 mb-1 block">Language</label>
  <select id="languageSelect" class="w-full px-3 py-2 rounded-md bg-gray-800 text-gray-100 border border-gray-600">
    <option value="">Auto - detect language</option>
    <option value="da">Danish</option>
    <option value="en">English</option>
    <option value="sv">Swedish</option>
    <option value="de">German</option>
    <option value="fr">French</option>
    <option value="es">Spanish</option>
    <!-- Add more as needed, using ISO 639-1 codes -->
  </select>
</div>

  <!-- Drop/Upload zone -->
  <div id="dropZone" class="w-full max-w-xl border-2 border-dashed border-gray-500 rounded-lg p-8 text-center cursor-pointer hover:border-indigo-400 transition">
    <p class="text-gray-300">Drag & drop your audio file here or click to browse</p>
    <input id="fileInput" type="file" name="file" accept=".mp3,.wav,.flac,.m4a,.ogg,.webm" class="hidden"/>
  </div>

  <!-- Audio preview -->
  <div id="audioPreviewContainer" class="mt-4 hidden w-full max-w-xl">
    <audio id="audioPreview" controls class="w-full"></audio>
  </div>

  <!-- Recording button (toggles dynamically) -->
  <div class="mt-4">
  <button id="recordBtn" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded shadow">
    Start Recording
  </button>  
  </div>

  <!-- Upload/transcribe button -->
  <button id="uploadBtn" class="mt-4 px-6 py-2 bg-indigo-600 hover:bg-indigo-500 rounded shadow disabled:opacity-50" disabled>Transcribe</button>

  <!-- Export SRT button-->
   <button id="uploadSrtBtn" class="mt-4 ml-2 px-6 py-2 bg-purple-600 hover:bg-purple-500 rounded shadow disabled:opacity-50" disabled>Export SRT</button>

  <!-- Loading spinner -->
  <div id="loading" class="hidden mt-6">
    <svg class="animate-spin h-8 w-8 text-indigo-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
    </svg>
    <p class="mt-2 text-sm text-gray-400">Transcribingâ€¦ please wait</p>
  </div>

  <!-- Result -->
  <div id="resultCard" class="hidden mt-8 w-full max-w-3xl bg-gray-800 rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold mb-2">Transcript</h2>
    <p id="transcriptText" class="mb-4 whitespace-pre-wrap text-gray-200"></p>
    <h3 class="text-lg font-semibold mb-2">Full JSON Response</h3>
    <pre><code id="jsonOutput" class="json"></code></pre>
  </div>

</div>

<script>
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const uploadBtn = document.getElementById('uploadBtn');
const loading = document.getElementById('loading');
const resultCard = document.getElementById('resultCard');
const transcriptText = document.getElementById('transcriptText');
const jsonOutput = document.getElementById('jsonOutput');
const audioPreviewContainer = document.getElementById('audioPreviewContainer');
const audioPreview = document.getElementById('audioPreview');

const startRecordingBtn = document.getElementById('startRecording');
const stopRecordingBtn = document.getElementById('stopRecording');

let selectedFile = null;
let mediaRecorder;
let audioChunks = [];

function showFile(file) {
  selectedFile = file;
  uploadBtn.disabled = false;
  uploadSrtBtn.disabled = false; 
  dropZone.querySelector('p').textContent = `Selected: ${selectedFile.name}`;
  const objectURL = URL.createObjectURL(selectedFile);
  audioPreview.src = objectURL;
  audioPreviewContainer.classList.remove("hidden");
}

// ==== Upload / drag & drop handling ====
dropZone.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', () => {
  if(fileInput.files.length) showFile(fileInput.files[0]);
});
dropZone.addEventListener('dragover', e => {
  e.preventDefault();
  dropZone.classList.add('border-indigo-400');
});
dropZone.addEventListener('dragleave', () => {
  dropZone.classList.remove('border-indigo-400');
});
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('border-indigo-400');
  if(e.dataTransfer.files.length) showFile(e.dataTransfer.files[0]);
});

// ==== Recording handling ====
const recordBtn = document.getElementById('recordBtn');
let isRecording = false;

recordBtn.onclick = async () => {
  if (!isRecording) {
    // Start recording
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) audioChunks.push(e.data);
      };
      mediaRecorder.start();
      isRecording = true;
      recordBtn.textContent = "Stop Recording";
      recordBtn.classList.remove('bg-green-600','hover:bg-green-500');
      recordBtn.classList.add('bg-red-600','hover:bg-red-500');
      dropZone.querySelector('p').textContent = "Recording... Speak now.";
    } catch (err) {
      alert("Microphone access denied or unavailable.");
    }
  } else {
    // Stop recording
    mediaRecorder.stop();
    mediaRecorder.onstop = () => {
      const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      showFile(new File([audioBlob], "recording.webm", { type: "audio/webm" }));
    };
    isRecording = false;
    recordBtn.textContent = "Start Recording";
    recordBtn.classList.remove('bg-red-600','hover:bg-red-500');
    recordBtn.classList.add('bg-green-600','hover:bg-green-500');
  }
};

// ==== Transcribe submission ====
const languageSelect = document.getElementById('languageSelect');

uploadBtn.addEventListener('click', async () => {
  if (!selectedFile) return;
  const formData = new FormData();
  formData.append("file", selectedFile);
  // add language
  formData.append("language", languageSelect.value);

  loading.classList.remove('hidden');
  resultCard.classList.add('hidden');
  uploadBtn.disabled = true;

  try {
    const res = await fetch('/transcribe', { method: 'POST', body: formData });
    const data = await res.json();

    transcriptText.textContent = data.transcript || "[no transcription]";
    jsonOutput.textContent = JSON.stringify(data, null, 2);
    hljs.highlightElement(jsonOutput);

    loading.classList.add('hidden');
    resultCard.classList.remove('hidden');
  } catch (err) {
    alert("Error: " + err);
    loading.classList.add('hidden');
  } finally {
    uploadBtn.disabled = false;
  }
});

const uploadSrtBtn = document.getElementById('uploadSrtBtn');

uploadSrtBtn.addEventListener('click', async () => {
  if (!selectedFile) return;
  const formData = new FormData();
  formData.append("file", selectedFile);
  formData.append("language", languageSelect.value);

  uploadSrtBtn.disabled = true;
  try {
    const res = await fetch('/transcribe/srt', { method: 'POST', body: formData });
    if (!res.ok) throw new Error(await res.text());

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'subtitles.srt';
    document.body.appendChild(a);
    a.click();
    a.remove();
  } catch (err) {
    alert("Error: " + err.message);
  } finally {
    uploadSrtBtn.disabled = false;
  }
});

</script>

</body>
</html>
